<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAZAP - Disparos</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { brand: { 500: '#22c55e', 600: '#16a34a' } } } } }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [token, setToken] = useState(localStorage.getItem('pazap_token'));
            const [username, setUsername] = useState(localStorage.getItem('pazap_user'));
            const [view, setView] = useState(token ? 'dashboard' : 'login');

            if (view === 'login') {
                return <LoginScreen onLogin={(t, u) => {
                    localStorage.setItem('pazap_token', t);
                    localStorage.setItem('pazap_user', u);
                    setToken(t); setUsername(u); setView('dashboard');
                }} />;
            }

            return (
                <Dashboard 
                    token={token} 
                    username={username} 
                    onLogout={() => {
                        localStorage.removeItem('pazap_token');
                        localStorage.removeItem('pazap_user');
                        setToken(null); setView('login');
                    }} 
                />
            );
        }

        // --- TELA DE LOGIN ---
        function LoginScreen({ onLogin }) {
            const [user, setUser] = useState('');
            const [pass, setPass] = useState('');
            const [mode, setMode] = useState('login');
            const [masterKey, setMasterKey] = useState('');
            const [msg, setMsg] = useState('');

            const handleLogin = async () => {
                const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username: user, password: pass }) });
                const data = await res.json();
                if(data.success) onLogin(data.token, data.username);
                else setMsg(data.error);
            };

            const handleCreate = async () => {
                const res = await fetch('/api/admin/create-user', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ masterKey, newUser: user, newPass: pass }) });
                const data = await res.json();
                if(data.success) { setMsg('Conta criada! Faça login.'); setMode('login'); }
                else setMsg(data.error);
            };

            return (
                <div className="h-screen flex items-center justify-center bg-gray-200">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-96">
                        <div className="text-center mb-6">
                            <i className="ph-fill ph-whatsapp-logo text-4xl text-brand-500"></i>
                            <h2 className="text-xl font-bold text-gray-700 mt-2">PAZAP {mode === 'create' && 'Admin'}</h2>
                        </div>
                        {msg && <div className="bg-red-100 text-red-600 p-2 rounded text-sm mb-4 text-center">{msg}</div>}
                        <input className="w-full p-3 border rounded mb-3" placeholder="Usuário" value={user} onChange={e=>setUser(e.target.value)} />
                        <input type="password" className="w-full p-3 border rounded mb-3" placeholder="Senha" value={pass} onChange={e=>setPass(e.target.value)} />
                        {mode === 'create' && <input type="password" className="w-full p-3 border border-orange-300 bg-orange-50 rounded mb-3" placeholder="Chave Mestra (Admin)" value={masterKey} onChange={e=>setMasterKey(e.target.value)} />}
                        {mode === 'login' ? <button onClick={handleLogin} className="w-full bg-brand-500 text-white p-3 rounded font-bold hover:bg-brand-600">Entrar</button> : <button onClick={handleCreate} className="w-full bg-gray-800 text-white p-3 rounded font-bold hover:bg-gray-900">Criar Conta</button>}
                        <div className="mt-4 text-center text-sm text-gray-500 cursor-pointer hover:underline" onClick={() => {setMode(mode==='login'?'create':'login'); setMsg('')}}>{mode === 'login' ? 'Criar nova conta' : 'Voltar para Login'}</div>
                    </div>
                </div>
            );
        }

        // --- MODAL QR ---
        const QrModal = ({ base64, onClose }) => (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div className="bg-white p-6 rounded-xl shadow-xl flex flex-col items-center">
                    <h3 className="font-bold text-lg mb-4">Conectar Whatsapp</h3>
                    <img src={base64} alt="QR Code" className="w-64 h-64 border rounded" />
                    <p className="text-sm text-gray-500 mt-2">Abra o WhatsApp > Aparelhos Conectados > Conectar</p>
                    <button onClick={onClose} className="mt-4 px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 w-full">Fechar</button>
                </div>
            </div>
        );

        // --- DASHBOARD ---
        function Dashboard({ token, username, onLogout }) {
            const [instanceName, setInstanceName] = useState('');
            const [logs, setLogs] = useState([]);
            const [status, setStatus] = useState('idle');
            const [progress, setProgress] = useState({success:0, fail:0, total:0});
            
            const [numbers, setNumbers] = useState('');
            const [msg, setMsg] = useState('');
            const [qrCode, setQrCode] = useState(null);
            const [isCreating, setIsCreating] = useState(false);

            // Fetch inicial
            useEffect(() => {
                fetch('/api/data', { headers: { 'x-auth-token': token } }).then(r => r.json()).then(d => { setInstanceName(d.instanceName || ''); if(d.logs) setLogs(d.logs); }).catch(() => onLogout());
            }, []);

            // Polling
            useEffect(() => {
                const interval = setInterval(async () => {
                    const res = await fetch('/api/campaign/status', { headers: { 'x-auth-token': token } });
                    const data = await res.json();
                    setStatus(data.status);
                    if(data.progress) setProgress(data.progress);
                    
                    const dRes = await fetch('/api/data', { headers: { 'x-auth-token': token } });
                    const dData = await dRes.json();
                    if(dData.logs) setLogs(dData.logs);
                }, 2000);
                return () => clearInterval(interval);
            }, []);

            const createInstance = async () => {
                const name = prompt("Digite um nome para sua instância (ex: sua_loja):");
                if (!name) return;
                setIsCreating(true);
                try {
                    const res = await fetch('/api/evo/create', { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-auth-token': token }, body: JSON.stringify({ newInstanceName: name }) });
                    const data = await res.json();
                    if (data.success) {
                        setInstanceName(name);
                        if(data.data.qrcode && data.data.qrcode.base64) setQrCode(data.data.qrcode.base64);
                        else alert("Instância criada! Clique em 'Conectar' para ver o QR Code.");
                    } else alert("Erro: " + data.error);
                } catch(e) { alert("Erro de conexão"); }
                setIsCreating(false);
            };

            const fetchQr = async () => {
                try {
                    const res = await fetch('/api/evo/qrcode', { headers: { 'x-auth-token': token } });
                    const data = await res.json();
                    if (data.success) {
                        if (data.connected) alert("WhatsApp já está conectado e pronto!");
                        else if (data.qrcode) setQrCode(data.qrcode);
                    } else alert("Erro: " + (data.error || "Tente novamente."));
                } catch(e) { alert("Erro ao buscar QR"); }
            };

            const deleteInstance = async () => {
                if(!confirm("Tem certeza? Isso vai desconectar o WhatsApp.")) return;
                await fetch('/api/evo/delete', { method: 'POST', headers: { 'x-auth-token': token } });
                setInstanceName('');
            };

            const start = async () => {
                const targets = numbers.split('\n').filter(n => n.length > 8);
                if(!targets.length) return alert('Sem números');
                if(!instanceName) return alert('Conecte o WhatsApp primeiro!');
                
                await fetch('/api/campaign/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify({ targets, messageData: { type: 'text', message: msg, options: { linkPreview: true } }, delays: { min: 10, max: 20 } })
                });
                alert('Campanha iniciada no servidor!');
            };

            const stop = async () => await fetch('/api/campaign/stop', { method: 'POST', headers: { 'x-auth-token': token } });

            return (
                <div className="flex h-screen overflow-hidden">
                    {qrCode && <QrModal base64={qrCode} onClose={() => setQrCode(null)} />}
                    
                    <aside className="w-72 bg-white border-r flex flex-col z-10 shadow-lg">
                        <div className="p-6 border-b">
                            <h1 className="font-bold text-gray-800 flex items-center gap-2">PAZAP <span className="text-xs bg-brand-100 text-brand-600 px-2 rounded uppercase">SaaS</span></h1>
                            <div className="text-xs text-gray-400 mt-1">Olá, {username}</div>
                        </div>
                        
                        <div className="p-6 space-y-6 flex-1">
                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Sua Conexão</label>
                                {instanceName ? (
                                    <div className="text-center">
                                        <div className="font-mono text-sm font-semibold text-gray-700 bg-white border p-2 rounded mb-3">{instanceName}</div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={fetchQr} className="bg-brand-500 text-white text-xs py-2 rounded hover:bg-brand-600 shadow font-medium">
                                                Conectar
                                            </button>
                                            <button onClick={deleteInstance} className="bg-red-50 text-red-500 text-xs py-2 rounded hover:bg-red-100 border border-red-100">
                                                Desconectar
                                            </button>
                                        </div>
                                        <div className="mt-2 flex items-center justify-center gap-1 text-[10px] text-green-600">
                                            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                            Pronto para uso
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-2">
                                        <p className="text-xs text-gray-400 mb-3">Nenhum WhatsApp vinculado.</p>
                                        <button onClick={createInstance} disabled={isCreating} className="w-full bg-gray-800 text-white text-xs py-2 rounded hover:bg-gray-900 shadow">
                                            {isCreating ? 'Criando...' : '+ Criar Instância'}
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            <div className="text-xs text-gray-400">
                                <p>1. Crie uma instância.</p>
                                <p>2. Clique em Conectar.</p>
                                <p>3. Escaneie o QR Code.</p>
                                <p>4. Inicie os disparos.</p>
                            </div>
                        </div>
                        <button onClick={onLogout} className="p-4 text-red-500 text-sm border-t hover:bg-red-50 flex items-center justify-center gap-2 font-medium">
                            <i className="ph-bold ph-sign-out"></i> Sair
                        </button>
                    </aside>

                    <main className="flex-1 bg-gray-50 p-8 overflow-y-auto">
                        {status === 'running' && (
                            <div className="bg-white p-4 rounded shadow mb-6 border-l-4 border-brand-500 animate-pulse flex justify-between items-center">
                                <div>
                                    <h3 className="font-bold text-brand-600">Disparando Campanha...</h3>
                                    <p className="text-sm text-gray-500">Enviados: {progress.success} | Falhas: {progress.fail} | Total: {progress.total}</p>
                                </div>
                                <button onClick={stop} className="bg-red-500 text-white px-4 py-1 rounded text-xs font-bold">PARAR</button>
                            </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full pb-20">
                            <div className="space-y-4">
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2"><i className="ph-fill ph-users"></i> Destinatários</h3>
                                    <textarea className="w-full h-40 border-gray-200 bg-gray-50 rounded-lg p-3 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none resize-none font-mono" placeholder="5511999998888&#10;5521988887777" value={numbers} onChange={e=>setNumbers(e.target.value)}></textarea>
                                    <div className="text-right text-xs text-gray-400 mt-1">{numbers.split('\n').filter(n=>n.length>8).length} contatos válidos</div>
                                </div>
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2"><i className="ph-fill ph-chat-text"></i> Mensagem</h3>
                                    <textarea className="w-full h-32 border-gray-200 bg-gray-50 rounded-lg p-3 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none resize-none" placeholder="Digite sua mensagem aqui..." value={msg} onChange={e=>setMsg(e.target.value)}></textarea>
                                </div>
                                
                                {status === 'idle' ? 
                                    <button onClick={start} className="w-full bg-brand-600 text-white px-6 py-4 rounded-xl shadow-lg font-bold hover:bg-brand-700 transition-transform active:scale-95 flex items-center justify-center gap-2">
                                        <i className="ph-bold ph-paper-plane-right"></i> INICIAR DISPARO
                                    </button> :
                                    <button disabled className="w-full bg-gray-300 text-gray-500 px-6 py-4 rounded-xl font-bold cursor-not-allowed">
                                        CAMPANHA EM ANDAMENTO
                                    </button>
                                }
                            </div>
                            
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 h-full max-h-[600px] flex flex-col overflow-hidden">
                                <div className="p-4 border-b bg-gray-50 font-semibold text-gray-600 text-sm">Histórico de Atividades</div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2 font-mono text-xs">
                                    {logs.length === 0 && <p className="text-gray-400 text-center mt-10">Nenhum registro recente.</p>}
                                    {logs.map((l, i) => (
                                        <div key={i} className={`flex gap-2 ${l.type==='error'?'text-red-500':l.type==='success'?'text-green-600':'text-gray-500'}`}>
                                            <span className="opacity-50 shrink-0">[{l.time.split(' ')[1]}]</span>
                                            <span className="break-all">{l.text}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>